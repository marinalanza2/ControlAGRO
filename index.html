<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ControlAGRO - O Fazendeiro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .offline-badge {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--n8);
            color: #fff;
            padding: 6px 12px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .offline-badge.show {
            display: flex;
        }

        .offline-badge svg {
            width: 14px;
            height: 14px;
        }

        .sync-ind {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            color: var(--g6);
            display: none;
        }

        .sync-ind.show {
            display: flex;
            animation: spin 1s linear infinite;
        }

        :root {
            --g9: #14532d;
            --g8: #166534;
            --g7: #15803d;
            --g6: #16a34a;
            --g5: #22c55e;
            --g4: #4ade80;
            --g3: #86efac;
            --g2: #bbf7d0;
            --g1: #dcfce7;
            --g0: #f0fdf4;
            --e5: #d97706;
            --e4: #f59e0b;
            --n9: #0f172a;
            --n8: #1e293b;
            --n7: #334155;
            --n6: #475569;
            --n5: #64748b;
            --n4: #94a3b8;
            --n3: #cbd5e1;
            --n2: #e2e8f0;
            --n1: #f1f5f9;
            --r: #dc2626
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--g0), var(--g1), var(--g0));
            min-height: 100vh;
            color: var(--n8)
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: #fff;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, .1)
        }

        @media(min-width:768px) {
            .app {
                margin: 20px auto;
                min-height: calc(100vh - 40px);
                border-radius: 24px
            }
        }

        .hdr {
            background: linear-gradient(135deg, var(--g8), var(--g7), var(--g6));
            padding: 20px;
            position: relative
        }

        .hdr::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 255, 255, .1), transparent 70%);
            border-radius: 50%
        }

        .hdr-c {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 1
        }

        .logo-s {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .logo-i {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, .3);
            background: #fff
        }

        .brand-n {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff
        }

        .brand-s {
            font-size: .7rem;
            color: var(--g2);
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase
        }

        .u-menu {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .notif {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, .15);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative
        }

        .notif:hover {
            background: rgba(255, 255, 255, .25)
        }

        .badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 18px;
            height: 18px;
            background: var(--e5);
            border-radius: 50%;
            font-size: .65rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--g7)
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--e5), var(--e4));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            font-size: .9rem;
            border: 2px solid rgba(255, 255, 255, .3)
        }

        .nav {
            display: flex;
            background: var(--g9);
            padding: 8px;
            gap: 4px
        }

        .nav-t {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: 0 0;
            color: var(--g3);
            font-family: 'Outfit', sans-serif;
            font-size: .75rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: .3s
        }

        .nav-t svg {
            width: 20px;
            height: 20px
        }

        .nav-t:hover {
            background: rgba(255, 255, 255, .1);
            color: #fff
        }

        .nav-t.act {
            background: #fff;
            color: var(--g8);
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1)
        }

        .main {
            padding: 20px;
            padding-bottom: 100px;
            min-height: calc(100vh - 200px)
        }

        .scr {
            display: none;
            animation: fadeIn .4s ease
        }

        .scr.act {
            display: block
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px
        }

        .stat {
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--g1);
            position: relative;
            overflow: hidden;
            transition: .3s
        }

        .stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--g5)
        }

        .stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1)
        }

        .stat.hl {
            background: linear-gradient(135deg, var(--g6), var(--g7));
            color: #fff;
            border: none
        }

        .stat.hl::before {
            background: var(--e4)
        }

        .stat.hl .stat-l {
            color: var(--g1)
        }

        .stat-v {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px
        }

        .stat-l {
            font-size: .75rem;
            color: var(--n5);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .sec-h {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px
        }

        .sec-t {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--n8);
            display: flex;
            align-items: center;
            gap: 8px
        }

        .sec-t svg {
            width: 20px;
            height: 20px;
            color: var(--g6)
        }

        .see-all {
            font-size: .8rem;
            color: var(--g6);
            font-weight: 600;
            background: 0 0;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px
        }

        .v-card {
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--g1);
            transition: .3s;
            cursor: pointer
        }

        .v-card:hover {
            border-color: var(--g3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1);
            transform: translateX(4px)
        }

        .v-hdr {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px
        }

        .v-cli {
            font-weight: 600;
            color: var(--n8);
            font-size: .95rem;
            margin-bottom: 2px
        }

        .v-prop {
            font-size: .8rem;
            color: var(--n5);
            display: flex;
            align-items: center;
            gap: 4px
        }

        .v-badge {
            padding: 4px 10px;
            border-radius: 99px;
            font-size: .65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .b-pro {
            background: var(--e4);
            color: #451a03
        }

        .b-ana {
            background: var(--g5);
            color: #fff
        }

        .b-sup {
            background: #3b82f6;
            color: #fff
        }

        .b-pos {
            background: #8b5cf6;
            color: #fff
        }

        .v-det {
            display: flex;
            gap: 16px;
            flex-wrap: wrap
        }

        .v-d {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: .75rem;
            color: var(--n6)
        }

        .v-d svg {
            width: 14px;
            height: 14px;
            color: var(--g5)
        }

        .v-st {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--n1)
        }

        .st-i {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--n3)
        }

        .st-i.neg {
            background: var(--e5);
            animation: pulse 2s infinite
        }

        .st-i.fec {
            background: var(--g5)
        }

        .st-i.per {
            background: var(--r)
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }

        .st-t {
            font-size: .75rem;
            font-weight: 500;
            color: var(--n6)
        }

        .st-v {
            margin-left: auto;
            font-size: .85rem;
            font-weight: 700;
            color: var(--g7)
        }

        .f-grp {
            margin-bottom: 20px
        }

        .f-lbl {
            display: block;
            font-size: .8rem;
            font-weight: 600;
            color: var(--n7);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .f-inp {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--n2);
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: .95rem;
            color: var(--n8);
            transition: .3s;
            background: #fff
        }

        .f-inp:focus {
            outline: 0;
            border-color: var(--g5);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, .1)
        }

        .f-inp::placeholder {
            color: var(--n4)
        }

        textarea.f-inp {
            min-height: 100px;
            resize: vertical
        }

        select.f-inp {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px
        }

        .f-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        .photo-up {
            border: 2px dashed var(--g3);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            background: var(--g0);
            cursor: pointer;
            transition: .3s
        }

        .photo-up:hover {
            border-color: var(--g5);
            background: var(--g1)
        }

        .photo-up.has {
            padding: 12px;
            border-style: solid;
            border-color: var(--g5)
        }

        .photo-up svg {
            width: 48px;
            height: 48px;
            color: var(--g4);
            margin-bottom: 12px
        }

        .photo-txt {
            font-size: .9rem;
            color: var(--n6);
            font-weight: 500
        }

        .photo-hint {
            font-size: .75rem;
            color: var(--n4);
            margin-top: 4px
        }

        .photo-prev {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 12px
        }

        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: .9rem;
            font-weight: 600;
            cursor: pointer;
            transition: .3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none
        }

        .btn-p {
            background: linear-gradient(135deg, var(--g6), var(--g7));
            color: #fff;
            box-shadow: 0 4px 14px rgba(22, 163, 74, .4)
        }

        .btn-p:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(22, 163, 74, .5)
        }

        .btn-p:disabled {
            background: var(--n3);
            box-shadow: none;
            cursor: not-allowed;
            transform: none
        }

        .btn-s {
            background: #fff;
            color: var(--g7);
            border: 2px solid var(--g2)
        }

        .btn-s:hover {
            background: var(--g0);
            border-color: var(--g3)
        }

        .btn svg {
            width: 18px;
            height: 18px
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--g5), var(--g6));
            border: none;
            color: #fff;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(22, 163, 74, .5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: .3s;
            z-index: 100
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 25px rgba(22, 163, 74, .6)
        }

        .fab svg {
            width: 28px;
            height: 28px
        }

        @media(min-width:768px) {
            .fab {
                right: calc(50% - 240px + 24px)
            }
        }

        .c-card {
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--g1);
            display: flex;
            align-items: center;
            gap: 14px;
            transition: .3s;
            cursor: pointer
        }

        .c-card:hover {
            border-color: var(--g3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1)
        }

        .c-av {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--g4), var(--g6));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0
        }

        .c-info {
            flex: 1;
            min-width: 0
        }

        .c-name {
            font-weight: 600;
            color: var(--n8);
            font-size: .95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .c-meta {
            font-size: .75rem;
            color: var(--n5);
            margin-top: 2px
        }

        .c-orig {
            display: inline-flex;
            padding: 2px 8px;
            background: var(--g1);
            border-radius: 99px;
            font-size: .65rem;
            font-weight: 600;
            color: var(--g7);
            text-transform: uppercase;
            margin-top: 6px
        }

        .c-vis {
            display: flex;
            flex-direction: column;
            align-items: flex-end
        }

        .c-vc {
            font-size: .8rem;
            font-weight: 700;
            color: var(--g6)
        }

        .c-lv {
            font-size: .65rem;
            color: var(--n4)
        }

        .search {
            position: relative;
            margin-bottom: 20px
        }

        .search input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            border: 2px solid var(--n2);
            border-radius: 16px;
            font-family: 'Outfit', sans-serif;
            font-size: .9rem;
            transition: .3s;
            background: #fff
        }

        .search input:focus {
            outline: 0;
            border-color: var(--g5);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, .1)
        }

        .search svg {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--n4)
        }

        .pills {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 16px;
            -webkit-overflow-scrolling: touch
        }

        .pills::-webkit-scrollbar {
            display: none
        }

        .pill {
            padding: 8px 16px;
            border-radius: 99px;
            border: 2px solid var(--n2);
            background: #fff;
            font-family: 'Outfit', sans-serif;
            font-size: .8rem;
            font-weight: 500;
            color: var(--n6);
            cursor: pointer;
            white-space: nowrap;
            transition: .3s
        }

        .pill:hover {
            border-color: var(--g3);
            color: var(--g7)
        }

        .pill.act {
            background: var(--g6);
            border-color: var(--g6);
            color: #fff
        }

        .empty {
            text-align: center;
            padding: 48px 24px
        }

        .empty svg {
            width: 80px;
            height: 80px;
            color: var(--g3);
            margin-bottom: 16px
        }

        .empty h3 {
            font-size: 1.1rem;
            color: var(--n7);
            margin-bottom: 8px
        }

        .empty p {
            font-size: .85rem;
            color: var(--n5);
            margin-bottom: 20px
        }

        .modal-o {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: flex-end;
            justify-content: center
        }

        .modal-o.act {
            display: flex
        }

        .modal {
            background: #fff;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            border-radius: 24px 24px 0 0;
            overflow: hidden;
            animation: slideUp .4s ease
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%)
            }

            to {
                transform: translateY(0)
            }
        }

        .modal-h {
            padding: 20px;
            border-bottom: 1px solid var(--n1);
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .modal-t {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--n8)
        }

        .modal-x {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--n1);
            color: var(--n6);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .modal-x:hover {
            background: var(--n2);
            color: var(--n8)
        }

        .modal-b {
            padding: 20px;
            max-height: calc(90vh - 140px);
            overflow-y: auto
        }

        .modal-f {
            padding: 16px 20px;
            border-top: 1px solid var(--n1);
            display: flex;
            gap: 12px
        }

        .vd-card {
            background: #fff;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--g1);
            transition: .3s
        }

        .vd-card:hover {
            border-color: var(--g3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1)
        }

        .vd-hdr {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px
        }

        .vd-av {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--e4), var(--e5));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 1rem
        }

        .vd-info h4 {
            font-weight: 600;
            color: var(--n8);
            font-size: .95rem
        }

        .vd-info span {
            font-size: .75rem;
            color: var(--n5)
        }

        .vd-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px
        }

        .vd-stat {
            text-align: center;
            padding: 12px;
            background: var(--g0);
            border-radius: 12px
        }

        .vd-stat-v {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--g7)
        }

        .vd-stat-l {
            font-size: .65rem;
            color: var(--n5);
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--g8);
            color: #fff;
            padding: 14px 24px;
            border-radius: 16px;
            font-size: .9rem;
            font-weight: 500;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, .1);
            z-index: 300;
            opacity: 0;
            transition: .4s;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1
        }

        .toast.err {
            background: var(--r)
        }

        .toast svg {
            width: 20px;
            height: 20px
        }

        .load {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--g1);
            border-top-color: var(--g5);
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .date-d {
            font-size: .75rem;
            color: var(--n5);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .date-d svg {
            width: 14px;
            height: 14px
        }

        .geo-st {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--g0);
            border-radius: 12px;
            font-size: .8rem;
            color: var(--g7);
            margin-bottom: 16px
        }

        .geo-st.err {
            background: #fef2f2;
            color: var(--r)
        }

        .geo-st svg {
            width: 16px;
            height: 16px
        }

        @media(max-width:360px) {
            .stats {
                grid-template-columns: 1fr
            }

            .f-row {
                grid-template-columns: 1fr
            }

            .nav-t {
                font-size: .65rem;
                padding: 10px 4px
            }
        }

        .login-scr {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--g8), var(--g6));
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px
        }

        .login-scr.hide {
            display: none
        }

        .login-box {
            background: #fff;
            border-radius: 24px;
            padding: 32px 24px;
            width: 100%;
            max-width: 360px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, .2)
        }

        .login-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 16px;
            border: 3px solid var(--g2)
        }

        .login-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--g8);
            margin-bottom: 4px
        }

        .login-sub {
            font-size: .85rem;
            color: var(--n5);
            margin-bottom: 24px
        }

        .login-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 16px;
            max-height: 280px;
            overflow-y: auto
        }

        .login-opt {
            padding: 14px 16px;
            border: 2px solid var(--n2);
            border-radius: 12px;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: .3s;
            text-align: left
        }

        .login-opt:hover {
            border-color: var(--g4);
            background: var(--g0)
        }

        .login-opt.master {
            border-color: var(--e4);
            background: #fffbeb
        }

        .login-opt.master:hover {
            border-color: var(--e5);
            background: #fef3c7
        }

        .login-av {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--g4), var(--g6));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: .9rem
        }

        .login-opt.master .login-av {
            background: linear-gradient(135deg, var(--e4), var(--e5))
        }

        .login-name {
            font-weight: 600;
            color: var(--n8);
            font-size: .95rem
        }

        .login-role {
            font-size: .7rem;
            color: var(--n5)
        }

        .visto {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 99px;
            font-size: .65rem;
            font-weight: 600;
            margin-left: 8px
        }

        .visto.sim {
            background: var(--g1);
            color: var(--g7)
        }

        .visto.nao {
            background: #fef2f2;
            color: var(--r)
        }

        .btn-visto {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: .7rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: .2s
        }

        .btn-visto.marcar {
            background: var(--g5);
            color: #fff
        }

        .btn-visto.marcar:hover {
            background: var(--g6)
        }

        .btn-visto.desmarcar {
            background: var(--n2);
            color: var(--n6)
        }

        .master-badge {
            background: linear-gradient(135deg, var(--e4), var(--e5));
            color: #fff;
            padding: 4px 10px;
            border-radius: 99px;
            font-size: .7rem;
            font-weight: 600;
            margin-left: 8px
        }

        .logout-btn {
            background: rgba(255, 255, 255, .2);
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: .75rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, .3)
        }

        .v-foto {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 12px;
            cursor: pointer;
            transition: .3s
        }

        .v-foto:hover {
            opacity: .9
        }

        .foto-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .9);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px
        }

        .foto-modal.act {
            display: flex
        }

        .foto-modal img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 12px
        }

        .foto-modal-x {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, .2);
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 1.5rem
        }

        .det-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            backdrop-filter: blur(4px);
            z-index: 250;
            display: none;
            align-items: flex-end;
            justify-content: center
        }

        .det-modal.act {
            display: flex
        }

        .det-box {
            background: #fff;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            border-radius: 24px 24px 0 0;
            overflow: hidden;
            animation: slideUp .4s ease
        }

        .det-hdr {
            padding: 20px;
            border-bottom: 1px solid var(--n1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--g7), var(--g6));
            color: #fff
        }

        .det-hdr h3 {
            font-size: 1.1rem;
            font-weight: 700
        }

        .det-x {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, .2);
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .det-body {
            padding: 20px;
            max-height: calc(85vh - 70px);
            overflow-y: auto
        }

        .det-section {
            margin-bottom: 20px
        }

        .det-section-title {
            font-size: .75rem;
            font-weight: 600;
            color: var(--g7);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px
        }

        .det-section-title svg {
            width: 16px;
            height: 16px
        }

        .det-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--n1)
        }

        .det-row:last-child {
            border-bottom: none
        }

        .det-label {
            font-size: .8rem;
            color: var(--n5);
            font-weight: 500
        }

        .det-value {
            font-size: .85rem;
            color: var(--n8);
            font-weight: 600;
            text-align: right;
            max-width: 60%;
            word-break: break-word
        }

        .det-foto {
            width: 100%;
            border-radius: 12px;
            margin-top: 12px;
            cursor: pointer
        }

        .det-desc {
            background: var(--g0);
            padding: 12px;
            border-radius: 8px;
            font-size: .85rem;
            color: var(--n7);
            line-height: 1.5;
            margin-top: 8px
        }

        /* Agenda & Stages */
        .c-stage {
            font-size: 0.75rem;
            color: #555;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 4px;
            font-weight: 500;
        }

        .c-stage.alert {
            background: #fee2e2;
            color: #b91c1c;
        }

        .dash-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .agenda-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .ag-task {
            display: flex;
            align-items: center;
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #ccc;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .ag-task:active {
            transform: scale(0.98);
        }

        .ag-task.t-red {
            border-left-color: #ef4444;
        }

        .ag-task.t-blue {
            border-left-color: #3b82f6;
        }

        .ag-task.t-green {
            border-left-color: #10b981;
        }

        .ag-icon {
            font-size: 1.25rem;
            margin-right: 0.75rem;
        }

        .ag-info {
            flex: 1;
        }

        .ag-t {
            font-weight: 500;
            font-size: 0.9rem;
            color: #111;
        }

        .ag-sub {
            font-size: 0.75rem;
            color: #666;
            margin-top: 2px;
        }

        .div-line {
            height: 1px;
            background: #eee;
            margin: 1rem 0;
        }

        .f-sub {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #004d40;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Stats Mini */
        .stats-mini {
            display: flex;
            gap: 0.75rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .stat-mini {
            background: white;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #666;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .stat-mini-v {
            font-weight: 600;
            color: var(--g6);
        }

        /* Agenda Enhanced */
        .ag-task.t-crop {
            border-left-color: #f59e0b;
            background: linear-gradient(90deg, #fffbeb 0%, white 30%);
        }

        .ag-task .ag-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
            font-weight: 600;
        }

        .ag-badge.urgent { background: #fee2e2; color: #b91c1c; }
        .ag-badge.today { background: #dbeafe; color: #1d4ed8; }
        .ag-badge.crop { background: #fef3c7; color: #b45309; }
        .ag-badge.soon { background: #d1fae5; color: #047857; }

        /* Plantios List */
        .plantios-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .plantio-item {
            display: flex;
            align-items: center;
            background: #f8faf8;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.6rem 0.75rem;
            gap: 0.5rem;
        }

        .plantio-item .plantio-icon { font-size: 1.1rem; }
        .plantio-item .plantio-info { flex: 1; }
        .plantio-item .plantio-cultura { font-weight: 600; font-size: 0.9rem; color: #333; }
        .plantio-item .plantio-meta { font-size: 0.75rem; color: #666; }
        .plantio-item .plantio-fase { font-size: 0.7rem; padding: 2px 6px; background: #fef3c7; color: #b45309; border-radius: 4px; }
        .plantio-item .plantio-rm { background: none; border: none; color: #999; font-size: 1.2rem; cursor: pointer; padding: 4px; }
        .plantio-item .plantio-rm:hover { color: #e53935; }

        .btn-add-plantio {
            width: 100%;
            padding: 0.6rem;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: transparent;
            color: #666;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-add-plantio:hover { border-color: var(--g6); color: var(--g6); }

        .add-plantio-form {
            background: #f0f7f0;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .add-plantio-form .f-row { margin-bottom: 0.5rem; }
        .add-plantio-form .f-row:last-child { margin-bottom: 0; }
        .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.8rem; }

        .plantios-empty {
            text-align: center;
            padding: 1rem;
            color: #999;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>
    <div class="login-scr" id="loginScr">
        <div class="login-box">
            <img src="logo.png" alt="O Fazendeiro" class="login-logo">
            <div class="login-title">ControlAGRO</div>
            <div class="login-sub">Selecione seu perfil para continuar</div>
            <div class="login-list" id="loginList">
                <div class="load">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="offline-badge" id="offBadge">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="1" y1="1" x2="23" y2="23" />
            <path d="M16.72 11.06A10.94 10.94 0 0119 12.55" />
            <path d="M5 12.55a10.94 10.94 0 015.17-2.39" />
            <path d="M10.71 5.05A16 16 0 0122.58 9" />
            <path d="M1.42 9a15.91 15.91 0 014.7-2.88" />
            <path d="M8.53 16.11a6 6 0 016.95 0" />
            <line x1="12" y1="20" x2="12.01" y2="20" />
        </svg>
        MODO OFFLINE
    </div>
    <div class="app" id="appMain" style="display:none">
        <header class="hdr">
            <div class="sync-ind" id="syncInd"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3" />
                </svg></div>
            <div class="hdr-c">

                <div class="logo-s">
                    <img src="logo.png" alt="O Fazendeiro" class="logo-i">
                    <div><span class="brand-n">ControlAGRO</span><br><span class="brand-s">O Fazendeiro</span></div>
                </div>
                <div class="u-menu">
                    <div class="avatar" id="userAv">--</div><span id="masterBadge"></span>
                    <button class="logout-btn" onclick="logout()"><svg viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
                            <polyline points="16 17 21 12 16 7" />
                            <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>Sair</button>
                </div>
            </div>
        </header>
        <nav class="nav">
            <button class="nav-t act" data-tab="dashboard"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" />
                    <rect x="14" y="3" width="7" height="7" />
                    <rect x="14" y="14" width="7" height="7" />
                    <rect x="3" y="14" width="7" height="7" />
                </svg>Dashboard</button>
            <button class="nav-t" data-tab="visitas"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z" />
                    <polyline points="14 2 14 8 20 8" />
                </svg>Visitas</button>
            <button class="nav-t" data-tab="clientes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75" />
                </svg>Clientes</button>
            <button class="nav-t" data-tab="equipe"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <line x1="19" y1="8" x2="19" y2="14" />
                    <line x1="22" y1="11" x2="16" y2="11" />
                </svg>Equipe</button>
        </nav>
        <main class="main">
            <section class="scr act" id="scr-dashboard">
                <div class="date-d"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg><span id="curDate"></span></div>

                <!-- AGENDA PRINCIPAL -->
                <div class="sec-h" style="margin-top:0.5rem">
                    <h2 class="sec-t"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>Agenda Inteligente</h2>
                </div>
                <div id="agendaList" class="agenda-list">
                    <div class="empty"><p>Carregando agenda...</p></div>
                </div>

                <!-- STATS RESUMIDOS -->
                <div class="stats-mini">
                    <div class="stat-mini"><span class="stat-mini-v" id="stVisitas">-</span> visitas</div>
                    <div class="stat-mini"><span class="stat-mini-v" id="stClientes">-</span> clientes</div>
                    <div class="stat-mini"><span class="stat-mini-v" id="stNegoc">-</span> negociação</div>
                    <div class="stat-mini" style="display:none"><span class="stat-mini-v" id="stConv">-</span> conversão</div>
                </div>
                <div class="sec-h">
                    <h2 class="sec-t"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <polyline points="12 6 12 12 16 14" />
                        </svg>Últimas Visitas</h2><button class="see-all" onclick="showTab('visitas')">Ver todas <svg
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14"
                            height="14">
                            <polyline points="9 18 15 12 9 6" />
                        </svg></button>
                </div>
                <div id="recentVis">
                    <div class="load">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>
            <section class="scr" id="scr-visitas">
                <div class="search"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8" />
                        <line x1="21" y1="21" x2="16.65" y2="16.65" />
                    </svg><input type="text" placeholder="Buscar visitas..." id="srcVis"></div>
                <div class="pills" id="pillsVis"><button class="pill act" data-f="todas">Todas</button><button
                        class="pill" data-f="prospeccao">Prospecção</button><button class="pill"
                        data-f="analise">Análise</button><button class="pill" data-f="suporte">Suporte</button><button
                        class="pill" data-f="posvenda">Pós-venda</button>
                </div>
                <div id="visList">
                    <div class="load">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>
            <section class="scr" id="scr-clientes">
                <div class="search"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8" />
                        <line x1="21" y1="21" x2="16.65" y2="16.65" />
                    </svg><input type="text" placeholder="Buscar clientes..." id="srcCli"></div>
                <div class="pills" id="pillsCli"><button class="pill act" data-f="todos">Todos</button><button
                        class="pill" data-f="indicacao">Indicação</button><button class="pill"
                        data-f="visita">Visita</button><button class="pill" data-f="marketing">Marketing</button><button
                        class="pill" data-f="evento">Evento</button>
                </div>
                <div id="cliList">
                    <div class="load">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>
            <section class="scr" id="scr-equipe">
                <div id="eqList">
                    <div class="load">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>
        </main>
        <button class="fab" id="fab" onclick="openModal('visita')"><svg viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
            </svg></button>
    </div>

    <div class="modal-o" id="modal-visita">
        <div class="modal">
            <div class="modal-h">
                <h3 class="modal-t">Nova Visita Técnica</h3><button class="modal-x" onclick="closeModal('visita')"><svg
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg></button>
            </div>
            <div class="modal-b">
                <div class="geo-st" id="geoSt"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" />
                        <circle cx="12" cy="10" r="3" />
                    </svg><span id="geoTxt">Obtendo localização...</span></div>
                <form id="frmVis">
                    <div class="f-grp"><label class="f-lbl">Cliente *</label><select class="f-inp" id="visCliente"
                            required>
                            <option value="">Selecione</option>
                        </select></div>
                    <div class="f-grp"><label class="f-lbl">Motivo *</label><select class="f-inp" id="visMotivo"
                            required>
                            <option value="">Selecione</option>
                            <option value="prospeccao">Prospecção</option>
                            <option value="analise">Análise de plantio/solo</option>
                            <option value="suporte">Suporte técnico</option>
                            <option value="posvenda">Pós-venda</option>
                        </select></div>
                    <div class="f-grp"><label class="f-lbl">Descrição *</label><textarea class="f-inp" id="visDesc"
                            placeholder="Detalhes da visita..." required></textarea></div>
                    <div class="f-grp"><label class="f-lbl">Foto do Local</label>
                        <div class="photo-up" id="photoUp" onclick="document.getElementById('photoIn').click()"><svg
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z" />
                                <circle cx="12" cy="13" r="4" />
                            </svg>
                            <div class="photo-txt">Toque para foto</div>
                            <div class="photo-hint">JPG, PNG até 5MB</div>
                        </div><input type="file" id="photoIn" accept="image/*" capture="environment"
                            style="display:none">
                    </div>
                    <div class="f-row">
                        <div class="f-grp"><label class="f-lbl">Status</label><select class="f-inp" id="visStat">
                                <option value="sem-venda">Sem proposta</option>
                                <option value="prospeccao">Prospecção</option>
                                <option value="negociacao">Negociação</option>
                                <option value="fechado">Fechado</option>
                                <option value="perdido">Perdido</option>
                            </select></div>
                        <div class="f-grp"><label class="f-lbl">Valor Est.</label><input type="text" class="f-inp"
                                id="visValor" placeholder="R$ 0,00"></div>
                    </div>
                    <div class="f-grp"><label class="f-lbl">Observações</label><textarea class="f-inp" id="visObs"
                            placeholder="Notas adicionais..."></textarea></div>
                </form>
            </div>
            <div class="modal-f"><button class="btn btn-s" style="flex:1"
                    onclick="closeModal('visita')">Cancelar</button><button class="btn btn-p" style="flex:2"
                    id="btnSaveVis" onclick="saveVisita()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>Registrar</button></div>
        </div>
    </div>

    <div class="modal-o" id="modal-cliente">
        <div class="modal">
            <div class="modal-h">
                <h3 class="modal-t">Novo Cliente</h3><button class="modal-x" onclick="closeModal('cliente')"><svg
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg></button>
            </div>
            <div class="modal-b">
                <form id="frmCli">
                    <div class="f-grp"><label class="f-lbl">Nome *</label><input type="text" class="f-inp" id="cliNome"
                            required></div>
                    <div class="f-row">
                        <div class="f-grp"><label class="f-lbl">CPF/CNPJ</label><input type="text" class="f-inp"
                                id="cliDoc"></div>
                        <div class="f-grp"><label class="f-lbl">Telefone *</label><input type="tel" class="f-inp"
                                id="cliTel" required></div>
                    </div>
                    <div class="f-grp"><label class="f-lbl">E-mail</label><input type="email" class="f-inp"
                            id="cliEmail"></div>
                    <div class="f-grp"><label class="f-lbl">Origem *</label><select class="f-inp" id="cliOrigem"
                            required>
                            <option value="">Selecione</option>
                            <option value="indicacao">Indicação</option>
                            <option value="visita">Visita à loja</option>
                            <option value="marketing">Marketing</option>
                            <option value="evento">Evento/Feira</option>
                            <option value="redes-sociais">Redes sociais</option>
                            <option value="outro">Outro</option>
                        </select></div>
                    <div class="f-grp"><label class="f-lbl">Propriedade *</label><input type="text" class="f-inp"
                            id="cliProp" required></div>
                    <div class="f-grp"><label class="f-lbl">Endereço *</label><input type="text" class="f-inp"
                            id="cliEnd" required></div>
                    <div class="f-row">
                        <div class="f-grp"><label class="f-lbl">Cidade *</label><input type="text" class="f-inp"
                                id="cliCidade" required></div>
                        <div class="f-grp"><label class="f-lbl">Área (ha)</label><input type="number" class="f-inp"
                                id="cliArea"></div>
                    </div>
                    <div class="f-grp"><label class="f-lbl">Culturas (Histórico)</label><input type="text" class="f-inp"
                            id="cliCult" placeholder="Soja, Milho..."></div>

                    <div class="div-line"></div>
                    <h4 class="f-sub">🌱 Plantios Ativos</h4>
                    <div id="plantiosList" class="plantios-list">
                        <!-- Plantios serão inseridos aqui -->
                    </div>
                    <div id="addPlantioForm" class="add-plantio-form" style="display:none">
                        <div class="f-row">
                            <div class="f-grp" style="flex:1">
                                <select class="f-inp" id="newPlantioCultura">
                                    <option value="">Cultura</option>
                                    <option value="Soja">Soja</option>
                                    <option value="Milho">Milho</option>
                                    <option value="Silagem">Silagem</option>
                                    <option value="Feijão">Feijão</option>
                                    <option value="Algodão">Algodão</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="f-grp" style="flex:1">
                                <select class="f-inp" id="newPlantioTipo">
                                    <option value="Safra">Safra</option>
                                    <option value="Safrinha">Safrinha</option>
                                    <option value="3ª Safra">3ª Safra</option>
                                </select>
                            </div>
                        </div>
                        <div class="f-row">
                            <div class="f-grp" style="flex:1">
                                <input type="date" class="f-inp" id="newPlantioData" placeholder="Data Plantio">
                            </div>
                            <button type="button" class="btn btn-p btn-sm" onclick="confirmarPlantio()">Adicionar</button>
                            <button type="button" class="btn btn-s btn-sm" onclick="cancelarPlantio()">X</button>
                        </div>
                    </div>
                    <button type="button" id="btnAddPlantio" class="btn-add-plantio" onclick="mostrarFormPlantio()">+ Adicionar Plantio</button>

                    <div class="div-line"></div>
                    <h4 class="f-sub">📅 Agendar Retorno</h4>
                    <div class="f-row">
                        <div class="f-grp"><label class="f-lbl">Data Lembrete</label><input type="date" class="f-inp"
                                id="cliLembreteData"></div>
                        <div class="f-grp"><label class="f-lbl">Nota/Motivo</label><input type="text" class="f-inp"
                                id="cliLembreteNota" placeholder="Ex: Ligar sobre adubo"></div>
                    </div>
                </form>
            </div>
            <div class="modal-f"><button class="btn btn-s" style="flex:1"
                    onclick="closeModal('cliente')">Cancelar</button><button class="btn btn-p" style="flex:2"
                    id="btnSaveCli" onclick="saveCliente()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <polyline points="20 6 9 17 4 12" />
                    </svg>Cadastrar</button></div>
        </div>
    </div>

    <div class="det-modal" id="detModal" onclick="if(event.target===this)closeDetalhes()">
        <div class="det-box">
            <div class="det-hdr">
                <h3 id="detTitle">Detalhes</h3><button class="det-x" onclick="closeDetalhes()">✕</button>
            </div>
            <div class="det-body" id="detBody"></div>
        </div>
    </div>

    <div class="foto-modal" id="fotoModal" onclick="closeFoto()">
        <button class="foto-modal-x" onclick="closeFoto()">✕</button>
        <img src="" id="fotoModalImg" alt="Foto da visita">
    </div>

    <div class="toast" id="toast"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 11-5.93-9.14" />
            <polyline points="22 4 12 14.01 9 11.01" />
        </svg><span id="toastMsg"></span></div>

    <script>
        const SUPABASE_URL = 'https://dgvkptcxchytqthjqozc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRndmtwdGN4Y2h5dHF0aGpxb3pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NzAzMzksImV4cCI6MjA4NDI0NjMzOX0.4RbEeD-loZnLzi-mN4W8LmyH1vHAFef5gRbOfnSNGG4';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW reg:', reg)).catch(err => console.error('SW err:', err)));
        }

        // Offline Database
        const DB_VER = 2;
        class OfflineDB {
            constructor() { this.db = null; this.ready = this.init(); }
            init() {
                return new Promise((resolve, reject) => {
                    if (!window.indexedDB) {
                        console.warn('IndexedDB nao suportado');
                        resolve();
                        return;
                    }
                    const timeout = setTimeout(() => {
                        console.warn('IndexedDB timeout');
                        resolve();
                    }, 5000);
                    const req = indexedDB.open('ControlAgroDB', DB_VER);
                    req.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('vendedores')) db.createObjectStore('vendedores', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('clientes')) db.createObjectStore('clientes', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('visitas')) db.createObjectStore('visitas', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('plantios')) db.createObjectStore('plantios', { keyPath: 'id' });
                        if (!db.objectStoreNames.contains('sync_queue')) db.createObjectStore('sync_queue', { keyPath: 'id', autoIncrement: true });
                    };
                    req.onsuccess = e => { clearTimeout(timeout); this.db = e.target.result; resolve(); };
                    req.onerror = e => { clearTimeout(timeout); console.error('IndexedDB erro:', e); resolve(); };
                });
            }
            async op(store, mode, fn) {
                await this.ready;
                if (!this.db) return mode === 'readonly' ? [] : undefined;
                return new Promise((resolve, reject) => {
                    try {
                        const tx = this.db.transaction(store, mode);
                        const st = tx.objectStore(store);
                        const req = fn(st);
                        req.onsuccess = e => resolve(e.target.result);
                        req.onerror = e => { console.error('DB op erro:', e); resolve(mode === 'readonly' ? [] : undefined); };
                    } catch (e) {
                        console.error('DB transaction erro:', e);
                        resolve(mode === 'readonly' ? [] : undefined);
                    }
                });
            }
            getAll(store) { return this.op(store, 'readonly', st => st.getAll()); }
            put(store, data) { return this.op(store, 'readwrite', st => st.put(data)); }
            add(store, data) { return this.op(store, 'readwrite', st => st.add(data)); }
            delete(store, id) { return this.op(store, 'readwrite', st => st.delete(id)); }
            clear(store) { return this.op(store, 'readwrite', st => st.clear()); }
        }
        const offlineDB = new OfflineDB();

        let geo = { lat: null, lng: null }, vendedores = [], clientes = [], visitas = [], plantios = [], curVend = null, photoFile = null, isMaster = false, masterName = null, editingClientId = null, editingVisitaId = null;

        // Utilities
        const fmtDate = d => { const dt = new Date(d); return dt.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }).replace('.', '') };
        const fmtCur = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);
        const fmtCurS = v => v >= 1e6 ? `R$ ${(v / 1e6).toFixed(1)}M` : v >= 1e3 ? `R$ ${(v / 1e3).toFixed(0)}k` : fmtCur(v);
        const initials = n => n ? n.split(' ').map(x => x[0]).slice(0, 2).join('').toUpperCase() : '--';
        const toast = (m, e = false) => { const t = document.getElementById('toast'); document.getElementById('toastMsg').textContent = m; t.classList.toggle('err', e); t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000) };
        const fileToBase64 = file => new Promise((resolve, reject) => { const r = new FileReader(); r.onload = () => resolve({ data: r.result, name: file.name, type: file.type }); r.onerror = reject; r.readAsDataURL(file); });
        const base64ToBlob = (b64) => { const [meta, data] = b64.split(','); const mime = meta.match(/:(.*?);/)[1]; const bin = atob(data); const arr = new Uint8Array(bin.length); for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i); return new Blob([arr], { type: mime }); };
        const badges = { prospeccao: { c: 'b-pro', t: 'Prospecção' }, analise: { c: 'b-ana', t: 'Análise' }, suporte: { c: 'b-sup', t: 'Suporte' }, posvenda: { c: 'b-pos', t: 'Pós-venda' } };
        const getBadge = m => badges[m] || { c: 'b-pro', t: m };
        const statuses = { 'sem-venda': { c: '', t: 'Sem proposta' }, prospeccao: { c: '', t: 'Prospecção' }, negociacao: { c: 'neg', t: 'Negociação' }, fechado: { c: 'fec', t: 'Fechado' }, perdido: { c: 'per', t: 'Perdido' } };
        const getStat = s => statuses[s] || { c: '', t: s };
        const origens = { indicacao: 'Indicação', visita: 'Visita', marketing: 'Marketing', evento: 'Evento', 'redes-sociais': 'Redes Sociais', outro: 'Outro' };
        const getOrig = o => origens[o] || o;

        // Geolocation
        function getGeo() {
            const st = document.getElementById('geoSt'), tx = document.getElementById('geoTxt');
            if (!navigator.geolocation) { st.classList.add('err'); tx.textContent = 'Geo não suportada'; return }
            navigator.geolocation.getCurrentPosition(
                p => { geo.lat = p.coords.latitude; geo.lng = p.coords.longitude; st.classList.remove('err'); tx.textContent = `Loc: ${geo.lat.toFixed(4)}, ${geo.lng.toFixed(4)}` },
                () => { st.classList.add('err'); tx.textContent = 'Permita acesso à localização' },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // Data Loading
        // Data Loading
        async function loadVendedores() {
            try {
                if (navigator.onLine) {
                    const { data, error } = await db.from('vendedores').select('*').eq('ativo', true).order('nome');
                    if (error) {
                        console.error('Erro ao carregar vendedores do Supabase:', error);
                        vendedores = await offlineDB.getAll('vendedores');
                    } else if (data && data.length > 0) {
                        vendedores = data;
                        await offlineDB.clear('vendedores');
                        for (const v of data) await offlineDB.put('vendedores', v);
                    } else {
                        console.warn('Nenhum vendedor retornado do Supabase, tentando offline...');
                        vendedores = await offlineDB.getAll('vendedores');
                    }
                } else {
                    vendedores = await offlineDB.getAll('vendedores');
                }
                vendedores.sort((a, b) => a.nome.localeCompare(b.nome));
                console.log('Vendedores carregados:', vendedores.length);
            } catch (e) {
                console.error('Erro fatal ao carregar vendedores:', e);
                vendedores = [];
            }
        }

        async function loadClientes() {
            if (navigator.onLine) {
                const { data, error } = await db.from('clientes').select('*').eq('ativo', true).order('nome');
                if (!error && data) {
                    clientes = data;
                    await offlineDB.clear('clientes');
                    for (const c of data) await offlineDB.put('clientes', c);
                } else clientes = await offlineDB.getAll('clientes');
            } else {
                clientes = await offlineDB.getAll('clientes');
            }
            clientes.sort((a, b) => a.nome.localeCompare(b.nome));
        }

        async function loadVisitas() {
            if (navigator.onLine) {
                const { data, error } = await db.from('visitas').select('*,clientes(nome,propriedade_nome,cidade),vendedores(nome)').order('data_hora', { ascending: false });
                if (!error && data) {
                    visitas = data;
                    await offlineDB.clear('visitas');
                    for (const v of data) await offlineDB.put('visitas', v);
                } else visitas = await offlineDB.getAll('visitas');
            } else {
                visitas = await offlineDB.getAll('visitas');
            }
            visitas.sort((a, b) => new Date(b.data_hora) - new Date(a.data_hora));
        }

        async function loadPlantios() {
            if (navigator.onLine) {
                const { data, error } = await db.from('plantios').select('*').eq('ativo', true);
                if (!error && data) {
                    plantios = data;
                    await offlineDB.clear('plantios');
                    for (const p of data) await offlineDB.put('plantios', p);
                } else plantios = await offlineDB.getAll('plantios');
            } else {
                plantios = await offlineDB.getAll('plantios');
            }
            console.log('Plantios carregados:', plantios.length);
        }

        function getPlantiosCliente(clienteId) {
            return plantios.filter(p => p.cliente_id === clienteId && p.ativo !== false);
        }

        // Plantios UI
        let tempPlantios = []; // Plantios temporários durante edição

        function renderPlantiosList() {
            const list = document.getElementById('plantiosList');
            if (!list) return;

            if (tempPlantios.length === 0) {
                list.innerHTML = '<div class="plantios-empty">Nenhum plantio cadastrado</div>';
                return;
            }

            list.innerHTML = tempPlantios.map((p, idx) => {
                const st = getEstagio(p.cultura, p.data_plantio);
                const faseHtml = st ? `<span class="plantio-fase">Dia ${st.dias} • ${st.fase}</span>` : '';
                const dataFmt = p.data_plantio ? new Date(p.data_plantio + 'T12:00:00').toLocaleDateString('pt-BR') : '';
                return `<div class="plantio-item">
                    <span class="plantio-icon">🌱</span>
                    <div class="plantio-info">
                        <div class="plantio-cultura">${p.cultura} (${p.tipo || 'Safra'})</div>
                        <div class="plantio-meta">Plantio: ${dataFmt} ${faseHtml}</div>
                    </div>
                    <button type="button" class="plantio-rm" onclick="removerPlantio(${idx})">×</button>
                </div>`;
            }).join('');
        }

        function mostrarFormPlantio() {
            document.getElementById('addPlantioForm').style.display = 'block';
            document.getElementById('btnAddPlantio').style.display = 'none';
        }

        function cancelarPlantio() {
            document.getElementById('addPlantioForm').style.display = 'none';
            document.getElementById('btnAddPlantio').style.display = 'block';
            document.getElementById('newPlantioCultura').value = '';
            document.getElementById('newPlantioTipo').value = 'Safra';
            document.getElementById('newPlantioData').value = '';
        }

        function confirmarPlantio() {
            const cultura = document.getElementById('newPlantioCultura').value;
            const tipo = document.getElementById('newPlantioTipo').value;
            const data = document.getElementById('newPlantioData').value;

            if (!cultura || !data) {
                toast('Preencha cultura e data', true);
                return;
            }

            tempPlantios.push({ cultura, tipo, data_plantio: data, isNew: true });
            renderPlantiosList();
            cancelarPlantio();
        }

        function removerPlantio(idx) {
            const p = tempPlantios[idx];
            if (p.id) {
                // Marcar para remoção (já existe no banco)
                p.toRemove = true;
            } else {
                // Remover da lista (ainda não salvo)
                tempPlantios.splice(idx, 1);
            }
            renderPlantiosList();
        }

        async function savePlantios(clienteId) {
            for (const p of tempPlantios) {
                if (p.toRemove && p.id) {
                    // Desativar no banco
                    await db.from('plantios').update({ ativo: false }).eq('id', p.id);
                } else if (p.isNew) {
                    // Criar novo
                    const { data } = await db.from('plantios').insert({
                        cliente_id: clienteId,
                        cultura: p.cultura,
                        tipo: p.tipo,
                        data_plantio: p.data_plantio,
                        ativo: true
                    }).select().single();
                    if (data) plantios.push(data);
                }
            }
            // Recarregar plantios
            await loadPlantios();
        }

        function carregarPlantiosCliente(clienteId) {
            tempPlantios = clienteId
                ? getPlantiosCliente(clienteId).map(p => ({ ...p }))
                : [];
            renderPlantiosList();
        }

        // Login
        function renderLoginList() {
            const list = document.getElementById('loginList');
            let html = '';
            if (vendedores.length === 0) {
                html += '<div style="text-align:center;padding:20px;color:#666;font-size:0.9rem;">Nenhum vendedor encontrado.<br>Verifique sua conexao.</div>';
            } else {
                html = vendedores.map(v => `<div class="login-opt" onclick="selectUser('${v.id}',false,null)"><div class="login-av">${initials(v.nome)}</div><div><div class="login-name">${v.nome}</div><div class="login-role">Vendedor</div></div></div>`).join('');
            }
            html += `<div class="login-opt master" onclick="selectUser(null,true,'IVO')"><div class="login-av">IVO</div><div><div class="login-name">IVO</div><div class="login-role">Gestor Master</div></div></div>`;
            html += `<div class="login-opt master" onclick="selectUser(null,true,'GLADSTON')"><div class="login-av">GL</div><div><div class="login-name">GLADSTON</div><div class="login-role">Gestor Master</div></div></div>`;
            list.innerHTML = html;
        }

        // Senhas dos vendedores
        const VENDOR_PASSWORDS = {
            'rodrigo': 'rodrigo26',
            'edmundo': 'edmundoagro26'
        };

        function selectUser(id, master, name, restore = false) {
            // Senha para masters
            if (master && !restore) {
                const senha = prompt('Digite a senha do gestor:');
                if (senha !== 'fazendeiro26') {
                    toast('Senha incorreta!', true);
                    return;
                }
            }

            // Senha para vendedores
            if (!master && !restore) {
                const vend = vendedores.find(v => v.id === id);
                if (vend) {
                    const nomeMin = vend.nome.toLowerCase().split(' ')[0]; // Primeiro nome
                    const senhaVend = VENDOR_PASSWORDS[nomeMin];
                    if (senhaVend) {
                        const senha = prompt(`Digite a senha de ${vend.nome}:`);
                        if (senha !== senhaVend) {
                            toast('Senha incorreta!', true);
                            return;
                        }
                    }
                }
            }

            isMaster = master;
            masterName = name;
            if (master) {
                curVend = { id: null, nome: name };
                document.getElementById('masterBadge').innerHTML = '<span class="master-badge">GESTOR</span>';
            } else {
                curVend = vendedores.find(v => v.id === id);
                document.getElementById('masterBadge').innerHTML = '';
            }
            if (!curVend) {
                // If restore fails (user not found), fallback to login
                console.warn('User restore failed: User not found in list');
                logout();
                return;
            }

            document.getElementById('userAv').textContent = initials(curVend.nome);
            document.getElementById('loginScr').classList.add('hide');
            document.getElementById('appMain').style.display = 'block';
            localStorage.setItem('controlagro_user', JSON.stringify({ id, master, name }));
            renderAll();
        }

        function logout() {
            localStorage.removeItem('controlagro_user');
            document.getElementById('loginScr').classList.remove('hide');
            document.getElementById('appMain').style.display = 'none';
            curVend = null; isMaster = false; masterName = null;
            renderLoginList();
        }

        function checkSavedLogin(retryCount = 0) {
            const saved = localStorage.getItem('controlagro_user');
            if (saved) {
                try {
                    const { id, master, name } = JSON.parse(saved);
                    if (master) { selectUser(null, true, name || 'IVO', true) }
                    else if (id) {
                        // Wait for vendedores to populate if empty
                        if (vendedores.length === 0) {
                            if (retryCount < 10) {
                                setTimeout(() => checkSavedLogin(retryCount + 1), 500);
                                return;
                            }
                            console.warn('Timeout: vendedores ainda vazios apos 5s');
                            renderLoginList();
                            return;
                        }
                        if (vendedores.find(v => v.id === id)) selectUser(id, false, null, true);
                        else {
                            console.warn('Usuario salvo nao encontrado na lista, mostrando login');
                            renderLoginList();
                        }
                    }
                    else { renderLoginList() }
                } catch (e) {
                    console.error('Erro ao restaurar login:', e);
                    renderLoginList();
                }
            } else { renderLoginList() }
        }

        // Navigation
        function showTab(tab) {
            document.querySelectorAll('.nav-t').forEach(t => t.classList.toggle('act', t.dataset.tab === tab));
            document.querySelectorAll('.scr').forEach(s => s.classList.toggle('act', s.id === `scr-${tab}`));
            document.getElementById('fab').onclick = () => openModal(tab === 'clientes' ? 'cliente' : 'visita');
        }
        document.querySelectorAll('.nav-t').forEach(t => t.addEventListener('click', () => showTab(t.dataset.tab)));

        // Modals
        function openModal(m) {
            if (m === 'cliente' && !editingClientId) {
                document.getElementById('frmCli').reset();
                document.querySelector('#modal-cliente .modal-t').textContent = 'Novo Cliente';
                document.querySelector('#btnSaveCli').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Cadastrar';
                carregarPlantiosCliente(null); // Limpar plantios para novo cliente
                cancelarPlantio(); // Esconder form de adicionar
            }
            if (m === 'visita' && !editingVisitaId) {
                document.getElementById('frmVis').reset();
                document.querySelector('#modal-visita .modal-t').textContent = 'Nova Visita Técnica';
                document.querySelector('#btnSaveVis').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Registrar';
                document.getElementById('photoUp').classList.remove('has');
                document.getElementById('photoUp').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg><div class="photo-txt">Toque para foto</div><div class="photo-hint">JPG, PNG até 5MB</div>';
            }
            document.getElementById(`modal-${m}`).classList.add('act'); document.body.style.overflow = 'hidden'; if (m === 'visita') { popCliSelect(); getGeo() }
        }
        function closeModal(m) {
            document.getElementById(`modal-${m}`).classList.remove('act'); document.body.style.overflow = '';
            if (m === 'cliente') { editingClientId = null; tempPlantios = []; }
            if (m === 'visita') { editingVisitaId = null; photoFile = null; }
        }
        function popCliSelect() {
            const sel = document.getElementById('visCliente');
            sel.innerHTML = '<option value="">Selecione</option>' + clientes.map(c => `<option value="${c.id}">${c.nome} - ${c.propriedade_nome}</option>`).join('');
        }
        function editCliente(id) {
            closeDetalhes();
            const c = clientes.find(x => String(x.id) === String(id));
            if (!c) return;
            editingClientId = id;
            document.getElementById('cliNome').value = c.nome;
            document.getElementById('cliDoc').value = c.cpf_cnpj || '';
            document.getElementById('cliTel').value = c.telefone;
            document.getElementById('cliEmail').value = c.email || '';
            document.getElementById('cliOrigem').value = c.origem;
            document.getElementById('cliProp').value = c.propriedade_nome;
            document.getElementById('cliEnd').value = c.endereco;
            document.getElementById('cliCidade').value = c.cidade;
            document.getElementById('cliArea').value = c.area_hectares || '';
            document.getElementById('cliCult').value = c.culturas_principais || '';

            // Plantios
            carregarPlantiosCliente(id);

            // Lembretes
            document.getElementById('cliLembreteData').value = c.lembrete_data ? c.lembrete_data.split('T')[0] : '';
            document.getElementById('cliLembreteNota').value = c.lembrete_nota || '';

            document.querySelector('#modal-cliente .modal-t').textContent = 'Editar Cliente';
            document.querySelector('#btnSaveCli').innerHTML = 'Salvar Alterações';
            openModal('cliente');
        }
        function editVisita(id) {
            closeDetalhes();
            const v = visitas.find(x => String(x.id) === String(id));
            if (!v) return;
            editingVisitaId = id;
            document.getElementById('visCliente').value = v.cliente_id;
            document.getElementById('visMotivo').value = v.motivo;
            document.getElementById('visDesc').value = v.descricao || '';
            document.getElementById('visStat').value = v.status_venda || 'sem-venda';
            document.getElementById('visValor').value = v.valor_estimado ? fmtCur(v.valor_estimado) : '';
            document.getElementById('visObs').value = v.observacoes || '';
            if (v.foto_url) {
                document.getElementById('photoUp').classList.add('has');
                document.getElementById('photoUp').innerHTML = '<img src="' + v.foto_url + '" style="max-width:100%;max-height:150px;border-radius:8px">';
            }
            document.querySelector('#modal-visita .modal-t').textContent = 'Editar Visita';
            document.querySelector('#btnSaveVis').innerHTML = 'Salvar Alterações';
            openModal('visita');
        }

        // Renders
        function renderVisCard(v, showVend = false) {
            const cli = v.clientes || clientes.find(c => c.id === v.cliente_id) || {};
            const vend = v.vendedores || vendedores.find(x => x.id === v.vendedor_id) || {};
            const b = getBadge(v.motivo), st = getStat(v.status_venda);
            const visto = v.visto_gestor;
            const vistoHtml = `<span class="visto ${visto ? 'sim' : 'nao'}">${visto ? '✓ Visto' : '● Não visto'}</span>`;
            const btnVistoHtml = isMaster ? `<button class="btn-visto ${visto ? 'desmarcar' : 'marcar'}" onclick="event.stopPropagation();toggleVisto('${v.id}',${!visto})">${visto ? 'Desmarcar' : 'Marcar visto'}</button>` : '';
            const fotoHtml = v.foto_url ? `<img src="${v.foto_url}" class="v-foto" onclick="event.stopPropagation();openFoto('${v.foto_url}')" alt="Foto">` : '';
            return `<div class="v-card" data-vid="${v.id}" ${isMaster ? 'onclick="openVisitaDetalhes(this.dataset.vid)"' : ''}><div class="v-hdr"><div><div class="v-cli">${cli.nome || 'Cliente'}${vistoHtml}</div><div class="v-prop"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>${cli.propriedade_nome || ''} - ${cli.cidade || ''}</div></div><span class="v-badge ${b.c}">${b.t}</span></div><div class="v-det"><div class="v-d"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>${fmtDate(v.data_hora)}</div>${showVend ? `<div class="v-d"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${vend.nome || ''}</div>` : ''}</div>${fotoHtml}<div class="v-st"><span class="st-i ${st.c}"></span><span class="st-t">${st.t}</span>${btnVistoHtml}${v.valor_estimado > 0 ? `<span class="st-v">${fmtCur(v.valor_estimado)}</span>` : ''}</div></div>`;
        }

        function openFoto(url) { document.getElementById('fotoModalImg').src = url; document.getElementById('fotoModal').classList.add('act') }
        function closeFoto() { document.getElementById('fotoModal').classList.remove('act') }

        async function toggleVisto(id, visto) {
            const { error } = await db.from('visitas').update({ visto_gestor: visto }).eq('id', id);
            if (error) { toast('Erro ao atualizar', true); return }
            await loadVisitas(); renderDash(); renderVisitas(); toast(visto ? 'Marcado como visto' : 'Desmarcado');
        }

        // Logic for Stage Calculation
        function getEstagio(cultura, dataPlantio) {
            if (!cultura || !dataPlantio) return null;
            const diff = Math.floor((new Date() - new Date(dataPlantio)) / (1000 * 60 * 60 * 24));
            if (diff < 0) return { dias: 0, fase: 'Pré-plantio', msg: 'Planejamento', alert: false };

            let fases = [];
            // Rules from User
            if (['Soja', 'Milho', 'Grãos'].includes(cultura)) {
                // 150 days cycle
                if (diff <= 5) return { dias: diff, fase: 'V2', msg: 'Germinação', alert: false };
                if (diff <= 14) return { dias: diff, fase: 'V3-V4', msg: 'Desenv. Inicial', alert: false };
                if (diff <= 28) return { dias: diff, fase: 'V6-V8', msg: 'Vegetativo', alert: false };
                if (diff <= 42) return { dias: diff, fase: 'V9-V10', msg: 'Pré-pendão', alert: false };
                if (diff <= 65) return { dias: diff, fase: 'VT (Pendão)', msg: 'Negociação!', alert: true }; // 56 days is critical
                if (diff <= 150) return { dias: diff, fase: 'R1-R6', msg: 'Reprodutivo', alert: false };
                return { dias: diff, fase: 'Colhido', msg: 'Pós-Safra', alert: true };
            } else if (cultura === 'Silagem') {
                // 120 days cycle
                // Assuming similar early stages
                if (diff <= 5) return { dias: diff, fase: 'V2', msg: 'Germinação', alert: false };
                if (diff <= 45) return { dias: diff, fase: 'Vegetativo', msg: 'Desenvolvimento', alert: false };
                if (diff <= 65) return { dias: diff, fase: 'VT', msg: 'Ponto de Corte?', alert: true };
                if (diff <= 120) return { dias: diff, fase: 'Maturação', msg: 'Colheita', alert: false };
                return { dias: diff, fase: 'Colhido', msg: 'Pós-Safra', alert: true };
            }
            return { dias: diff, fase: 'Ciclo Ativo', msg: 'Acompanhar', alert: false };
        }

        function renderCliCard(c) {
            const vend = vendedores.find(v => v.id === c.vendedor_id) || {};
            const numVis = visitas.filter(v => v.cliente_id === c.id).length;

            // Plantios ativos
            const cliPlantios = getPlantiosCliente(c.id);
            let stageHtml = '';
            cliPlantios.forEach(p => {
                const estagio = getEstagio(p.cultura, p.data_plantio);
                if (estagio) {
                    stageHtml += `<div class="c-stage ${estagio.alert ? 'alert' : ''}">${p.cultura} (${p.tipo || 'Safra'}) • Dia ${estagio.dias}</div>`;
                }
            });

            return `<div class="c-card" data-cid="${c.id}" onclick="openClienteDetalhes(this.dataset.cid)"><div class="c-av">${initials(c.nome)}</div><div class="c-info"><div class="c-name">${c.nome}</div><div class="c-meta">${c.propriedade_nome} • ${c.cidade}</div>${stageHtml}<div class="c-orig">${getOrig(c.origem)}</div></div><div class="c-vis"><span class="c-vc">${numVis} visitas</span><span class="c-lv">${vend.nome || ''}</span></div></div>`;
        }

        function renderVendCard(v) {
            const vis = visitas.filter(x => x.vendedor_id === v.id);
            const clis = clientes.filter(c => c.vendedor_id === v.id);
            const vendas = vis.filter(x => x.status_venda === 'fechado').reduce((a, x) => a + (parseFloat(x.valor_estimado) || 0), 0);
            return `<div class="vd-card"><div class="vd-hdr"><div class="vd-av">${initials(v.nome)}</div><div class="vd-info"><h4>${v.nome}</h4><span>${v.email}</span></div></div><div class="vd-stats"><div class="vd-stat"><div class="vd-stat-v">${vis.length}</div><div class="vd-stat-l">Visitas</div></div><div class="vd-stat"><div class="vd-stat-v">${clis.length}</div><div class="vd-stat-l">Clientes</div></div><div class="vd-stat"><div class="vd-stat-v">${fmtCurS(vendas)}</div><div class="vd-stat-l">Vendas</div></div></div></div>`;
        }

        function renderDash() {
            document.getElementById('curDate').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const myVisitas = getMyVisitas();
            const myClientes = getMyClientes();
            const now = new Date(), visMes = myVisitas.filter(v => { const d = new Date(v.data_hora); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear() }).length;
            const negoc = myVisitas.filter(v => v.status_venda === 'negociacao').reduce((a, v) => a + (parseFloat(v.valor_estimado) || 0), 0);
            const fech = myVisitas.filter(v => v.status_venda === 'fechado').length, tot = myVisitas.filter(v => ['fechado', 'perdido'].includes(v.status_venda)).length;
            const taxa = tot > 0 ? Math.round(fech / tot * 100) : 0;
            document.getElementById('stVisitas').textContent = visMes;
            document.getElementById('stClientes').textContent = myClientes.length;
            document.getElementById('stNegoc').textContent = fmtCurS(negoc);
            document.getElementById('stConv').textContent = taxa + '%';
            document.getElementById('recentVis').innerHTML = myVisitas.slice(0, 3).map(v => renderVisCard(v, true)).join('') || '<div class="empty"><p>Nenhuma visita</p></div>';

            renderAgenda();
        }

        function renderAgenda() {
            // Agenda Logic
            const agendaDiv = document.getElementById('agendaList');
            if (!agendaDiv) return; // Add div to HTML first

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            let tarefas = [];
            const myClientes = getMyClientes();

            // 1. Lembretes e Follow-ups
            myClientes.forEach(c => {
                if (c.lembrete_data) {
                    const dt = new Date(c.lembrete_data); dt.setHours(0, 0, 0, 0);
                    const diff = (dt - hoje) / (1000 * 60 * 60 * 24);

                    if (diff < 0) tarefas.push({ type: 'ATRASADO', date: dt, cli: c, msg: c.lembrete_nota || 'Retomar contato', badge: 'ATRASADO' });
                    else if (diff === 0) tarefas.push({ type: 'HOJE', date: dt, cli: c, msg: c.lembrete_nota || 'Retomar contato', badge: 'HOJE' });
                    else if (diff <= 7) tarefas.push({ type: 'FUTURO', date: dt, cli: c, msg: c.lembrete_nota || 'Retomar contato', badge: fmtDateShort(dt) });
                }
            });

            // 2. TODOS os plantios ativos dos clientes
            myClientes.forEach(c => {
                const cliPlantios = getPlantiosCliente(c.id);
                cliPlantios.forEach(p => {
                    const st = getEstagio(p.cultura, p.data_plantio);
                    if (st) {
                        tarefas.push({
                            type: st.alert ? 'CICLO_ALERTA' : 'CICLO',
                            date: new Date(),
                            cli: c,
                            msg: `${p.cultura} (${p.tipo || 'Safra'}) - ${st.fase}`,
                            badge: `Dia ${st.dias}`,
                            dias: st.dias,
                            fase: st.fase
                        });
                    }
                });
            });

            // Sort: Atrasado -> Hoje -> Ciclo Alerta -> Ciclo -> Futuro
            const order = { 'ATRASADO': 1, 'HOJE': 2, 'CICLO_ALERTA': 3, 'CICLO': 4, 'FUTURO': 5 };
            tarefas.sort((a, b) => order[a.type] - order[b.type]);

            if (tarefas.length === 0) {
                agendaDiv.innerHTML = '<div class="empty"><p>Nenhum cliente com safra ativa ou follow-up agendado</p></div>';
                return;
            }

            agendaDiv.innerHTML = tarefas.map(t => {
                let cls = '', badgeCls = '', icon = '📅';
                if (t.type === 'ATRASADO') { cls = 't-red'; badgeCls = 'urgent'; icon = '⚠️'; }
                else if (t.type === 'HOJE') { cls = 't-blue'; badgeCls = 'today'; icon = '📅'; }
                else if (t.type === 'CICLO_ALERTA') { cls = 't-crop'; badgeCls = 'crop'; icon = '🌾'; }
                else if (t.type === 'CICLO') { cls = 't-crop'; badgeCls = 'crop'; icon = '🌱'; }
                else { cls = ''; badgeCls = 'soon'; icon = '📆'; }

                return `<div class="ag-task ${cls}" onclick="editCliente('${t.cli.id}')">
                    <div class="ag-icon">${icon}</div>
                    <div class="ag-info">
                        <div class="ag-t">${t.msg}</div>
                        <div class="ag-sub">${t.cli.nome} • ${t.cli.propriedade_nome || ''}</div>
                    </div>
                    <div class="ag-badge ${badgeCls}">${t.badge}</div>
                </div>`;
            }).join('');
        }

        function fmtDateShort(d) {
            return d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }).replace('.', '');
        }

        // Filtrar dados por vendedor (masters veem tudo)
        function getMyVisitas() {
            if (isMaster) return visitas;
            return visitas.filter(v => v.vendedor_id === curVend?.id);
        }

        function getMyClientes() {
            if (isMaster) return clientes;
            return clientes.filter(c => c.vendedor_id === curVend?.id);
        }

        function renderVisitas(filter = 'todas') {
            let list = getMyVisitas();
            if (filter !== 'todas') list = list.filter(v => v.motivo === filter);
            document.getElementById('visList').innerHTML = list.length ? list.map(v => renderVisCard(v, true)).join('') : '<div class="empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14.5 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V7.5L14.5 2z"/></svg><h3>Nenhuma visita</h3><p>Registre sua primeira visita</p></div>';
        }

        function renderClientes(filter = 'todos') {
            let list = getMyClientes();
            if (filter !== 'todos') list = list.filter(c => c.origem === filter);
            document.getElementById('cliList').innerHTML = list.length ? list.map(c => renderCliCard(c)).join('') : '<div class="empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><h3>Nenhum cliente</h3><p>Cadastre seu primeiro cliente</p></div>';
        }

        function renderEquipe() {
            // Vendedores só veem a si mesmos na equipe, masters veem todos
            const lista = isMaster ? vendedores : vendedores.filter(v => v.id === curVend?.id);
            document.getElementById('eqList').innerHTML = lista.map(v => renderVendCard(v)).join('') || '<div class="empty"><p>Nenhum vendedor</p></div>';
        }

        // Filters
        document.querySelectorAll('#pillsVis .pill').forEach(p => p.addEventListener('click', () => { document.querySelectorAll('#pillsVis .pill').forEach(x => x.classList.remove('act')); p.classList.add('act'); renderVisitas(p.dataset.f) }));
        document.querySelectorAll('#pillsCli .pill').forEach(p => p.addEventListener('click', () => { document.querySelectorAll('#pillsCli .pill').forEach(x => x.classList.remove('act')); p.classList.add('act'); renderClientes(p.dataset.f) }));

        // Search
        document.getElementById('srcVis').addEventListener('input', e => { const q = e.target.value.toLowerCase(); document.querySelectorAll('#visList .v-card').forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none') });
        document.getElementById('srcCli').addEventListener('input', e => { const q = e.target.value.toLowerCase(); document.querySelectorAll('#cliList .c-card').forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none') });

        // Photo
        document.getElementById('photoIn').addEventListener('change', function (e) {
            const f = e.target.files[0]; if (!f) return; photoFile = f;
            const r = new FileReader();
            r.onload = ev => { const up = document.getElementById('photoUp'); up.classList.add('has'); up.innerHTML = `<img src="${ev.target.result}" class="photo-prev">` };
            r.readAsDataURL(f);
        });

        // Save Visita
        async function saveVisita() {
            const btn = document.getElementById('btnSaveVis'); btn.disabled = true;
            const cliId = document.getElementById('visCliente').value;
            const motivo = document.getElementById('visMotivo').value;
            const desc = document.getElementById('visDesc').value;
            const stat = document.getElementById('visStat').value;
            const valor = parseFloat(document.getElementById('visValor').value.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
            const obs = document.getElementById('visObs').value;
            if (!cliId || !motivo || !desc) { toast('Preencha campos obrigatórios', true); btn.disabled = false; return }

            const payload = { cliente_id: cliId, motivo, descricao: desc, status_venda: stat, valor_estimado: valor, observacoes: obs };

            if (navigator.onLine) {
                let fotoUrl = null;
                if (photoFile) {
                    const ext = photoFile.name.split('.').pop();
                    const path = `${Date.now()}.${ext}`;
                    const { data: upData, error: upErr } = await db.storage.from('visitas-fotos').upload(path, photoFile, { cacheControl: '3600', upsert: false });
                    if (!upErr) {
                        const { data } = db.storage.from('visitas-fotos').getPublicUrl(path);
                        fotoUrl = data.publicUrl;
                    }
                }
                if (photoFile) payload.foto_url = fotoUrl;

                let data, error;
                if (editingVisitaId) {
                    const res = await db.from('visitas').update(payload).eq('id', editingVisitaId).select('*,clientes(nome,propriedade_nome,cidade),vendedores(nome)').single();
                    data = res.data; error = res.error;
                } else {
                    payload.vendedor_id = curVend?.id;
                    payload.latitude = geo.lat;
                    payload.longitude = geo.lng;
                    payload.data_hora = new Date().toISOString();
                    const res = await db.from('visitas').insert(payload).select('*,clientes(nome,propriedade_nome,cidade),vendedores(nome)').single();
                    data = res.data; error = res.error;
                }
                if (error) { toast('Erro ao salvar: ' + error.message, true); btn.disabled = false; return }
                await offlineDB.put('visitas', data);
                await loadVisitas(); renderDash(); renderVisitas(); toast(editingVisitaId ? 'Visita atualizada!' : 'Visita registrada!');
            } else {
                // Offline Save
                if (editingVisitaId) {
                    payload.id = editingVisitaId;
                    const oldVisita = visitas.find(v => String(v.id) === String(editingVisitaId));
                    if (oldVisita) { payload.clientes = oldVisita.clientes; payload.vendedores = oldVisita.vendedores; payload.data_hora = oldVisita.data_hora; payload.latitude = oldVisita.latitude; payload.longitude = oldVisita.longitude; payload.vendedor_id = oldVisita.vendedor_id; }
                    const photoData = photoFile ? await fileToBase64(photoFile) : null;
                    await offlineDB.add('sync_queue', { type: 'VISITA_UPDATE', payload, photo: photoData });
                    await offlineDB.put('visitas', { ...oldVisita, ...payload });
                } else {
                    payload.id = 'TEMP_' + Date.now();
                    payload.vendedor_id = curVend?.id;
                    payload.latitude = geo.lat;
                    payload.longitude = geo.lng;
                    payload.data_hora = new Date().toISOString();
                    payload.clientes = clientes.find(c => String(c.id) === String(cliId)) || {};
                    payload.vendedores = curVend;
                    const photoData = photoFile ? await fileToBase64(photoFile) : null;
                    await offlineDB.add('sync_queue', { type: 'VISITA', payload, photo: photoData });
                    await offlineDB.put('visitas', payload);
                }
                await loadVisitas(); renderDash(); renderVisitas(); toast('Salvo offline. Sincronizará depois.');
            }

            closeModal('visita'); document.getElementById('frmVis').reset(); photoFile = null; editingVisitaId = null;
            document.getElementById('photoUp').classList.remove('has'); document.getElementById('photoUp').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg><div class="photo-txt">Toque para foto</div><div class="photo-hint">JPG, PNG até 5MB</div>';
            btn.disabled = false;
        }

        // Save Cliente
        async function saveCliente() {
            const btn = document.getElementById('btnSaveCli'); btn.disabled = true;
            const nome = document.getElementById('cliNome').value;
            const doc = document.getElementById('cliDoc').value;
            const tel = document.getElementById('cliTel').value;
            const email = document.getElementById('cliEmail').value;
            const origem = document.getElementById('cliOrigem').value;
            const prop = document.getElementById('cliProp').value;
            const end = document.getElementById('cliEnd').value;
            const cidade = document.getElementById('cliCidade').value;
            const area = parseFloat(document.getElementById('cliArea').value) || null;
            const cult = document.getElementById('cliCult').value;

            // Lembretes
            const lembrete_data = document.getElementById('cliLembreteData').value || null;
            const lembrete_nota = document.getElementById('cliLembreteNota').value;

            if (!nome || !tel || !origem || !prop || !end || !cidade) { toast('Preencha campos obrigatórios', true); btn.disabled = false; return }

            const payload = {
                vendedor_id: curVend?.id, nome, cpf_cnpj: doc, telefone: tel, email, origem,
                propriedade_nome: prop, endereco: end, cidade, area_hectares: area, culturas_principais: cult,
                lembrete_data, lembrete_nota
            };

            let clienteId = editingClientId;

            if (navigator.onLine) {
                let error, data;
                if (editingClientId) {
                    const res = await db.from('clientes').update(payload).eq('id', editingClientId).select().single();
                    error = res.error; data = res.data;
                } else {
                    const res = await db.from('clientes').insert(payload).select().single();
                    error = res.error; data = res.data;
                    clienteId = data?.id;
                }

                if (error) { toast('Erro: ' + error.message, true); btn.disabled = false; return }

                // Salvar plantios
                if (clienteId) {
                    await savePlantios(clienteId);
                }

                await offlineDB.put('clientes', data);
                await loadClientes(); await loadPlantios(); renderDash(); renderClientes(); toast(editingClientId ? 'Cliente atualizado!' : 'Cliente cadastrado!');
            } else {
                // Offline
                if (editingClientId) {
                    payload.id = editingClientId;
                    await offlineDB.add('sync_queue', { type: 'CLIENTE_UPDATE', payload });
                    await offlineDB.put('clientes', payload);
                } else {
                    payload.id = 'TEMP_' + Date.now();
                    await offlineDB.add('sync_queue', { type: 'CLIENTE_INSERT', payload });
                    await offlineDB.put('clientes', payload);
                }
                await loadClientes(); renderDash(); renderClientes(); toast('Salvo offline. Sincronizará depois.');
            }

            closeModal('cliente'); document.getElementById('frmCli').reset(); editingClientId = null;
            btn.disabled = false;
        }

        // Detalhes
        function openVisitaDetalhes(id) {
            const v = visitas.find(x => String(x.id) === String(id));
            if (!v) { alert('Visita não encontrada'); return; }
            const cli = v.clientes || clientes.find(c => c.id === v.cliente_id) || {};
            const vend = v.vendedores || vendedores.find(x => x.id === v.vendedor_id) || {};
            const b = getBadge(v.motivo), st = getStat(v.status_venda);

            const detModal = document.getElementById('detModal');
            const detTitle = document.getElementById('detTitle');
            const detBody = document.getElementById('detBody');

            detTitle.textContent = 'Detalhes da Visita';
            detBody.innerHTML =
                '<div class="det-section">' +
                '<div class="det-section-title">Vendedor</div>' +
                '<div class="det-row"><span class="det-label">Nome</span><span class="det-value">' + (vend.nome || '-') + '</span></div>' +
                '</div>' +
                '<div class="det-section">' +
                '<div class="det-section-title">Cliente</div>' +
                '<div class="det-row"><span class="det-label">Nome</span><span class="det-value">' + (cli.nome || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Propriedade</span><span class="det-value">' + (cli.propriedade_nome || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Cidade</span><span class="det-value">' + (cli.cidade || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Telefone</span><span class="det-value">' + (cli.telefone || '-') + '</span></div>' +
                '</div>' +
                '<div class="det-section">' +
                '<div class="det-section-title">Visita</div>' +
                '<div class="det-row"><span class="det-label">Data/Hora</span><span class="det-value">' + fmtDate(v.data_hora) + '</span></div>' +
                '<div class="det-row"><span class="det-label">Motivo</span><span class="det-value">' + b.t + '</span></div>' +
                '<div class="det-row"><span class="det-label">Status</span><span class="det-value">' + st.t + '</span></div>' +
                '<div class="det-row"><span class="det-label">Valor</span><span class="det-value">' + fmtCur(v.valor_estimado) + '</span></div>' +
                '<div class="det-row"><span class="det-label">Localização</span><span class="det-value">' + (v.latitude && v.longitude ? v.latitude.toFixed(4) + ', ' + v.longitude.toFixed(4) : '-') + '</span></div>' +
                '</div>' +
                '<div class="det-section">' +
                '<div class="det-section-title">Descrição</div>' +
                '<div class="det-desc">' + (v.descricao || '-') + '</div>' +
                '</div>' +
                (v.observacoes ? '<div class="det-section"><div class="det-section-title">Observações</div><div class="det-desc">' + v.observacoes + '</div></div>' : '') +
                (v.foto_url ? '<div class="det-section"><div class="det-section-title">Foto</div><img src="' + v.foto_url + '" class="det-foto" onclick="openFoto(\'' + v.foto_url + '\')"></div>' : '') +
                (v.vendedor_id === curVend?.id || isMaster ? '<div style="text-align:center;margin-top:20px"><button onclick="editVisita(\'' + v.id + '\')" style="flex:1;background:var(--g6);color:#fff;border:none;padding:12px 24px;border-radius:12px;font-weight:600;font-size:0.9rem;cursor:pointer">Editar Visita</button></div>' : '');

            detModal.classList.add('act');
        }

        function openClienteDetalhes(id) {
            // Permite acesso para vendors também
            const c = clientes.find(x => String(x.id) === String(id));
            if (!c) { alert('Cliente não encontrado'); return; }
            const vend = vendedores.find(v => v.id === c.vendedor_id) || {};
            const cliVisitas = visitas.filter(v => v.cliente_id === c.id);

            const detModal = document.getElementById('detModal');
            const detTitle = document.getElementById('detTitle');
            const detBody = document.getElementById('detBody');

            detTitle.textContent = 'Detalhes do Cliente';
            detBody.innerHTML =
                '<div class="det-section">' +
                '<div class="det-section-title">Dados Pessoais</div>' +
                '<div class="det-row"><span class="det-label">Nome</span><span class="det-value">' + (c.nome || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">CPF/CNPJ</span><span class="det-value">' + (c.cpf_cnpj || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Telefone</span><span class="det-value">' + (c.telefone || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">E-mail</span><span class="det-value">' + (c.email || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Origem</span><span class="det-value">' + getOrig(c.origem) + '</span></div>' +
                '</div>' +
                '<div class="det-section">' +
                '<div class="det-section-title">Propriedade</div>' +
                '<div class="det-row"><span class="det-label">Nome</span><span class="det-value">' + (c.propriedade_nome || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Endereço</span><span class="det-value">' + (c.endereco || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Cidade</span><span class="det-value">' + (c.cidade || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Área</span><span class="det-value">' + (c.area_hectares ? c.area_hectares + ' ha' : '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Culturas</span><span class="det-value">' + (c.culturas_principais || '-') + '</span></div>' +
                '</div>' +
                '<div class="det-section">' +
                '<div class="det-section-title">Responsável</div>' +
                '<div class="det-row"><span class="det-label">Vendedor</span><span class="det-value">' + (vend.nome || '-') + '</span></div>' +
                '<div class="det-row"><span class="det-label">Total Visitas</span><span class="det-value">' + cliVisitas.length + '</span></div>' +
                '</div>' +
                (c.observacoes ? '<div class="det-section"><div class="det-section-title">Observações</div><div class="det-desc">' + c.observacoes + '</div></div>' : '') +
                '<div style="text-align:center;margin-top:20px;display:flex;gap:10px">' +
                '<button onclick="editCliente(\'' + c.id + '\')" style="flex:1;background:var(--g6);color:#fff;border:none;padding:12px;border-radius:12px;font-weight:600;font-size:0.9rem;cursor:pointer">Editar Dados</button>' +
                '</div>';

            detModal.classList.add('act');
        }

        function closeDetalhes() { document.getElementById('detModal').classList.remove('act') }

        function renderAll() {
            renderDash(); renderVisitas(); renderClientes(); renderEquipe();
        }

        // Sync Logic
        async function syncData() {
            if (!navigator.onLine) return;
            const queue = await offlineDB.getAll('sync_queue');
            if (queue.length === 0) return;

            document.getElementById('syncInd').classList.add('show');
            console.log('Syncing items:', queue.length);

            for (const item of queue) {
                try {
                    if (item.type === 'VISITA') {
                        let fotoUrl = null;
                        if (item.photo) {
                            const blob = base64ToBlob(item.photo.data);
                            const ext = item.photo.name.split('.').pop();
                            const path = `${Date.now()}.${ext}`;
                            const { error: upErr } = await db.storage.from('visitas-fotos').upload(path, blob, { cacheControl: '3600', upsert: false });
                            if (!upErr) {
                                const { data } = db.storage.from('visitas-fotos').getPublicUrl(path);
                                fotoUrl = data.publicUrl;
                            }
                        }
                        const payload = { ...item.payload, foto_url: fotoUrl };
                        delete payload.id; delete payload.clientes; delete payload.vendedores; // Clean up temp data

                        const { data, error } = await db.from('visitas').insert(payload).select().single();
                        if (!error) {
                            await offlineDB.delete('sync_queue', item.id);
                            // Replace temp item in local store with real one
                            await offlineDB.delete('visitas', item.payload.id);
                            await offlineDB.put('visitas', data);
                        }
                    } else if (item.type === 'CLIENTE_INSERT') {
                        const payload = { ...item.payload };
                        delete payload.id;
                        const { data, error } = await db.from('clientes').insert(payload).select().single();
                        if (!error) {
                            await offlineDB.delete('sync_queue', item.id);
                            await offlineDB.delete('clientes', item.payload.id);
                            await offlineDB.put('clientes', data);
                        }
                    } else if (item.type === 'CLIENTE_UPDATE') {
                        const payload = { ...item.payload };
                        const id = payload.id;
                        const { data, error } = await db.from('clientes').update(payload).eq('id', id).select().single();
                        if (!error) {
                            await offlineDB.delete('sync_queue', item.id);
                            await offlineDB.put('clientes', data);
                        }
                    } else if (item.type === 'VISITA_UPDATE') {
                        let fotoUrl = null;
                        if (item.photo) {
                            const blob = base64ToBlob(item.photo.data);
                            const ext = item.photo.name.split('.').pop();
                            const path = `${Date.now()}.${ext}`;
                            const { error: upErr } = await db.storage.from('visitas-fotos').upload(path, blob, { cacheControl: '3600', upsert: false });
                            if (!upErr) {
                                const { data } = db.storage.from('visitas-fotos').getPublicUrl(path);
                                fotoUrl = data.publicUrl;
                            }
                        }
                        const payload = { ...item.payload };
                        if (fotoUrl) payload.foto_url = fotoUrl;
                        const id = payload.id;
                        delete payload.id; delete payload.clientes; delete payload.vendedores;
                        const { data, error } = await db.from('visitas').update(payload).eq('id', id).select().single();
                        if (!error) {
                            await offlineDB.delete('sync_queue', item.id);
                            await offlineDB.put('visitas', data);
                        }
                    }
                } catch (e) {
                    console.error('Sync error for item:', item, e);
                }
            }

            document.getElementById('syncInd').classList.remove('show');
            await loadVisitas(); await loadClientes(); renderAll(); toast('Sincronização concluída!');
        }

        function updateOnlineStatus() {
            const isOffline = !navigator.onLine;
            document.getElementById('offBadge').classList.toggle('show', isOffline);
            if (!isOffline) syncData();
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Init
        async function init() {
            try {
                updateOnlineStatus();
                await Promise.race([
                    loadVendedores(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout loadVendedores')), 10000))
                ]).catch(e => console.error('loadVendedores falhou:', e));

                await Promise.race([
                    loadClientes(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout loadClientes')), 10000))
                ]).catch(e => console.error('loadClientes falhou:', e));

                await Promise.race([
                    loadVisitas(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout loadVisitas')), 10000))
                ]).catch(e => console.error('loadVisitas falhou:', e));

                await Promise.race([
                    loadPlantios(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout loadPlantios')), 10000))
                ]).catch(e => console.error('loadPlantios falhou:', e));

                console.log('Init completo - vendedores:', vendedores.length, 'clientes:', clientes.length, 'plantios:', plantios.length);
            } catch (e) {
                console.error('Erro na inicializacao:', e);
            }
            // Sempre chamar checkSavedLogin, mesmo com erro
            checkSavedLogin();
            if (navigator.onLine) syncData();
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>